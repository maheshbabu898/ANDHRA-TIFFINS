<!DOCTYPE html>
<html>
<head>
<audio id="bellSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>
  <title>Admin Panel - Andhra Tiffens</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial; background:#f4f4f4; padding:20px; }
    .card {
      background:white;
      padding:15px;
      margin-bottom:15px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    button {
      padding:6px 10px;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
  </style>
</head>
<body>

<h2>üì¶ Orders</h2>
<div id="ordersContainer"></div>

<h2>üçΩÔ∏è Manage Items</h2>
<div id="itemsContainer"></div>

<script>
let lastOrderCount = 0;
function loadOrders(){
  fetch('/orders')
  .then(res=>res.json())
  .then(data=>{
// üîî Play sound if new order comes
if (data.length > lastOrderCount) {
  document.getElementById("bellSound").play();
}
lastOrderCount = data.length;
    const container = document.getElementById("ordersContainer");
    container.innerHTML = "";

    data.forEach(order=>{
     let itemsHtml = "";

if (order.items) {
  try {
    const parsedItems = JSON.parse(order.items);
    parsedItems.forEach(i => {
      itemsHtml += `${i.name} x ${i.qty}<br>`;
    });
  } catch (e) {
    itemsHtml = order.items;
  }
}

container.innerHTML += `
  <div class="card">
    <b>Order ID:</b> ${order.orderCode}<br>
    <b>Name:</b> ${order.name}<br>
    <b>Mobile:</b> ${order.mobile}<br>
    <b>Items:</b><br> ${itemsHtml}<br>
    <b>Total:</b> ‚Çπ${order.total}<br>
    <b>Address:</b> ${order.address}<br>
    <b>Payment:</b> ${order.payment_status}<br>
    <b>Status:</b> ${order.order_status}<br>

    ${order.order_status !== 'Approved'
      ? `<button onclick="approveOrder('${order.orderCode}')">Approve</button>`
      : `<span style="color:green;">Approved ‚úÖ</span>`
    }
  </div>
`;
    });
  });
}

function approveOrder(code){
  fetch('/approve-order',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ orderCode:code })
  }).then(()=>loadOrders());
}

function loadItems(){
  fetch('/items')
  .then(res=>res.json())
  .then(items=>{
    const container = document.getElementById("itemsContainer");
    container.innerHTML = "";

    items.forEach(item=>{
      container.innerHTML += `
        <div class="card">
          ${item.name} - ‚Çπ${item.price}
          <button onclick="toggleItem(${item.id}, ${item.available ? 0 : 1})"
            style="background:${item.available ? 'green' : 'red'};color:white;">
            ${item.available ? 'Available' : 'Not Available'}
          </button>
        </div>
      `;
    });
  });
}

function toggleItem(id, status){
  fetch('/toggle-item',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ id:id, available:status })
  }).then(()=>loadItems());
}

loadOrders();
loadItems();
setInterval(loadOrders, 5000);
</script>

</body>
</html>